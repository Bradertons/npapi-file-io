<!DOCTYPE XHTML>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>NPAPI File IO test</title>
  <script type="text/javascript" src="../app/jsUnitCore.js"></script>
  <script type="text/javascript">
  var plugin = document.createElement("embed");
  plugin.setAttribute("type", "application/x-npapi-file-io");
  document.documentElement.appendChild(plugin);
  
  function getPlatform() {
    return "windows";
  }
  
  function getPath(filename) {
    if (getPlatform() === "windows") {
      return "C:\\svn\\npapi-file-io\\test\\files\\" + filename;
    }
    throw "Unsupported platform";
  }
  
  function testDetectsPlatformAsWindows() {
    assertEquals("windows", getPlatform());
  }
  
  function testGetPathReturnsFileInPath() {
    var filename = "file";
    assertEquals("C:\\svn\\npapi-file-io\\test\\files\\" + filename, getPath(filename));
  }

  function testFileExistsReturnsFalseForNonExistentFile() {
    var nonexistent = getPath("nonexistent.txt");
    assertFalse(plugin.fileExists(nonexistent));
  }
  
  function testFileExistsReturnsTrueForExistentFile() {
    var exists = getPath("exists.txt");
    assertTrue(plugin.fileExists(exists));
  }
  
  function testGetTextFileForTextFileReturnsFileContents() {
    var exists = getPath("exists.txt");
    assertEquals("I contain\nsome text\n  on multiple lines", plugin.getTextFile(exists));
  }
  
  function testGetBinaryFileForTextFileReturnsFileContents() {
    var a = getPath("a.txt");
    assertArrayEquals([97], plugin.getBinaryFile(a));
  }
  
  function testGetBinaryFileForTextFileReturnsNewLinesWithoutCarriageReturns() {
    var exists = getPath("exists.txt");
    assertArrayEquals([73, 32, 99, 111, 110, 116, 97, 105, 110, 13, 10, 115, 111, 109, 101, 32, 116, 101, 120, 116, 13, 10, 32, 32, 111, 110, 32, 109, 117, 108, 116, 105, 112, 108, 101, 32, 108, 105, 110, 101, 115], plugin.getBinaryFile(exists));
  }
  
  function testGetBinaryFileForBinaryFileContainingNullReturnsFileContents() {
    var a = getPath("containsnull.txt");
    assertArrayEquals([97, 0, 99], plugin.getBinaryFile(a));
  }
  
  function testGetTextFileForBinaryFileContainingNullThrows() {
    var a = getPath("containsnull.txt");
    assertThrows(function() { plugin.getTextFile(a) });
  }
  
  function testUnsupportedFunctionThrows() {
    try {
      plugin.foo();
      fail("Expected exception");
    } catch (e) {
      //Expected
    }
  }

  
  function testFileExistsWithNoArgumentsThrows() {
    assertThrows(plugin.fileExists);
  }
  
  function testFileExistsWithNonStringThrows() {
    callWithNonStringThrows(plugin.fileExists);
  }
  
  function testFileExistsWithTwoArgumentsThrows() {
    callWithTwoArgumentsThrows(plugin.fileExists);
  }
  
  function testFileExistsWithNoArgumentsThrows() {
    assertThrows(plugin.getTextFile);
  }
  
  function testFileExistsWithNonStringThrows() {
    callWithNonStringThrows(plugin.getTextFile);
  }
  
  function testFileExistsWithTwoArgumentsThrows() {
    callWithTwoArgumentsThrows(plugin.getTextFile);
  }
  
  function testFileExistsWithNoArgumentsThrows() {
    assertThrows(plugin.getBinaryFile);
  }
  
  function testFileExistsWithNonStringThrows() {
    callWithNonStringThrows(plugin.getBinaryFile);
  }
  
  function testFileExistsWithTwoArgumentsThrows() {
    callWithTwoArgumentsThrows(plugin.getBinaryFile);
  }
  
  function assertThrows(fun) {
    try {
      fun();
      fail("Expected exception");
    } catch (e) {
      //Expected
    }
  }
  
  function callWithNonStringThrows(fun) {
    assertThrows(function () { fun(1); });
    assertThrows(function () { fun(true); });
    assertThrows(function () { fun({}); });
    assertThrows(function () { fun([]); });
  }
  
  function callWithTwoArgumentsThrows(fun) {
    assertThrows(function() { fun("foo", "bar"); });
  }
  
  //TODO: ls
  //TODO: getTmpPath
  //TODO: mkdir
  //TODO: createText
  //TODO: createBinary
  </script>
</head>
<body>
</body>
</html>